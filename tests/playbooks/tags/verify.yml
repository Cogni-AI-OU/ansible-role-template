---
- name: Build NixOS test image when needed
  hosts: localhost
  gather_facts: false
  tags: always
  vars:
    controller_python: "{{ ansible_playbook_python }}"
    nixos_built_image: cogni-ai-template-nixos:latest
    nixos_dockerfile_output: "{{ playbook_dir }}/../../../molecule/resources/playbooks/Dockerfile.template-on-nixos"
    nixos_dockerfile_template: "{{ playbook_dir }}/../../../molecule/resources/playbooks/Dockerfile.j2"
  tasks:
    - name: Render Dockerfile for NixOS image
      ansible.builtin.template:
        src: "{{ nixos_dockerfile_template }}"
        dest: "{{ nixos_dockerfile_output }}"
        mode: "0644"
      vars:
        item:
          name: template-on-nixos-latest
          image: nixos/nix:latest
        ansible_python_interpreter: "{{ controller_python }}"
      when: "'template-on-nixos-latest' in groups['docker_containers']"

    - name: Build NixOS image with Python preinstalled
      community.docker.docker_image:
        name: "{{ nixos_built_image }}"
        build:
          path: "{{ nixos_dockerfile_output | dirname }}"
          dockerfile: "{{ nixos_dockerfile_output | basename }}"
        source: build
        force_source: true
      when: "'template-on-nixos-latest' in groups['docker_containers']"
      vars:
        ansible_python_interpreter: "{{ controller_python }}"

- name: Ensure Docker containers are up-and-running
  gather_facts: false
  hosts: docker_containers

  pre_tasks:
    - name: Ensure container is started
      community.docker.docker_container:
        command: sleep infinity
        image: "{{ container_image }}"
        name: "{{ inventory_hostname }}"
        pull: "{{ (container_image is not search('cogni-ai-template-nixos')) | bool }}"
        state: started
      delegate_to: localhost
      vars:
        # Use system Python with requests installed for controller-side Docker modules.
        ansible_python_interpreter: "{{ controller_python }}"

    - name: Wait for container to be ready
      community.docker.docker_container_info:
        name: "{{ inventory_hostname }}"
      register: container_info
      until:
        - container_info is defined
        - (container_info.container is defined and container_info.container.State.Running | default(false) | bool)
      delegate_to: localhost
      changed_when: false
      vars:
        # Use system Python with requests installed for controller-side Docker modules.
        ansible_python_interpreter: "{{ controller_python }}"

    - name: Install Python 3 on Alpine
      ansible.builtin.raw: |
        test -e "{{ ansible_python_interpreter }}" || (apk update && apk add --no-cache python3 py3-pip)
      changed_when: false
      when: container_image is search('alpine')

    - name: Install Python 3 on NixOS
      ansible.builtin.raw: |
        test -e "{{ ansible_python_interpreter }}" || (nix-env -iA nixpkgs.python3 nixpkgs.python3Packages.pip)
      changed_when: false
      when: container_image is search('nixos')

    - name: Install Python 3 on Ubuntu/Debian
      ansible.builtin.raw: |
        test -e "{{ ansible_python_interpreter }}" || (apt-get update && apt-get install -y python3 python3-pip)
      changed_when: false
      when: container_image is search('ubuntu') or container_image is search('debian')

  tags: always
  vars:
    controller_python: "{{ ansible_playbook_python }}"
    nixos_built_image: cogni-ai-template-nixos:latest
    nixos_dockerfile_output: "{{ playbook_dir }}/../../../molecule/resources/playbooks/Dockerfile.template-on-nixos"
    nixos_dockerfile_template: "{{ playbook_dir }}/../../../molecule/resources/playbooks/Dockerfile.j2"
    container_image_map:
      template-on-alpine-latest: alpine:latest
      template-on-debian-latest: debian:latest
      template-on-nixos-latest: "{{ nixos_built_image }}"
      template-on-ubuntu-jammy: ubuntu:jammy
      template-on-ubuntu-latest: ubuntu:latest
      template-on-ubuntu-noble: ubuntu:noble
    container_image: "{{ container_image_map[inventory_hostname] | default('ubuntu:latest') }}"
  vars_files:
    - ../../vars/main.yml

- name: Import cogni-ai.template role (verify tag)
  hosts: docker_containers
  gather_facts: true
  tasks:
    - name: Import cogni-ai.template role
      ansible.builtin.import_role:
        name: cogni-ai.template
  tags: verify
  post_tasks:
    - name: Stop Docker containers
      community.docker.docker_container:
        name: "{{ inventory_hostname }}"
        state: stopped
      delegate_to: localhost
      failed_when: false
